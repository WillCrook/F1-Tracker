<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://d3faj0w6aqatyx.cloudfront.net/uploads/2018/01/19151152/FORMULA-1%C2%AE-UNLEASHES-NEW-BRAND-IDENTITY-INSPIRED-BY-ITS-FANS-OPTION-2.jpg">
    <title>F1 Tracker</title>
    <style>
      body {
        background-color: #121212;
        color: #f8f9fa;
      }
      .navbar {
        background-color: #181818;
        border-bottom: 2px solid #e10600;
      }
      .btn-primary {
        background-color: #e10600;
        border: none;
      }
      .btn-primary:hover {
        background-color: #c20000;
      }
      .card {
        background-color: #222;
        border: 1px solid #444;
        transition: transform 0.3s;
      }
      .card:hover {
        transform: scale(1.05);
        border-color: #e10600;
      }
      .toast {
        background-color: #222;
      }
      .toast-body {
        color: #f8f9fa;
      }
      .dropdown-menu {
        background-color: #222;
      }
      .table {
        color: #f8f9fa;
      }
      .list-group-item {
        background-color: #222;
        color: #f8f9fa;
      }
    </style>
    <script>
      // Function to update the button text based on the selected dropdown item
      function updateDropdownText(buttonId, selectedItem) {
        const button = document.getElementById(buttonId);
        button.textContent = selectedItem;  // Update the button text
      }
    
      //function to trigger graph generation based on the selected dropdown values
      function generateGraph() {
        const graphType = document.getElementById('graphTypeButton').textContent;
        const grandPrix = document.getElementById('grandPrixButton').textContent;
    
        if (graphType === 'Select Graph Type' || grandPrix === 'Select Grand Prix') {
          alert('Please select both Graph Type and Grand Prix.');
          return;
        }

        //flash message for generating graph
        const toastMessage = `Generating ${graphType} graph for ${grandPrix}!`;
        showToast(toastMessage, 'info');

        //fetch to generate the graph
        fetch(`/generate-graph?graphType=${encodeURIComponent(graphType)}&grandPrix=${encodeURIComponent(grandPrix)}`)
          .then(response => response.blob())
          .then(imageBlob => {
            const imageUrl = URL.createObjectURL(imageBlob);
            document.getElementById('graphImage').src = imageUrl;
            //flash another message when the graph is loaded
            showToast('Graph successfully generated!', 'success');
          })
          .catch(error => {
            console.error('Error generating graph:', error);
            showToast('Error generating the graph. Please try again.', 'danger');
          });
      }

      //helper function to show toasts
      function showToast(message, category) {
        const toastContainer = document.getElementById('toastContainer');
        const toastHTML = `
          <div class="toast align-items-center text-white bg-${category} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
            <div class="d-flex">
              <div class="toast-body">
                ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>`;
        
        toastContainer.innerHTML = toastHTML;
        
        const toastEl = document.querySelector('.toast');
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      }

      // Show toast messages after page load
      document.addEventListener('DOMContentLoaded', function() {
        const toastElList = [].slice.call(document.querySelectorAll('.toast'));
        const toastList = toastElList.map(function(toastEl) {
          return new bootstrap.Toast(toastEl);
        });
        toastList.forEach(toast => toast.show());
      });

      //Countdown function
      var eventDate = new Date("{{ data.upcominggrandprixdate }}").getTime();  //set to JavaScript Date

        function startCountdown() {
            var now = new Date().getTime(); //get the time from the user's browser
            var distance = eventDate - now;

            //calculate days, hours, minutes, and seconds
            var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            //display the countdown
            document.getElementById("countdown").innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s ";

            //if the countdown is over then display race is live message
            if (distance < 0) {
                clearInterval(x); //stop the countdown
                document.getElementById("countdown").innerHTML = "{{ data.upcominggrandprix }} IS LIVE!";
            }
        }

        // Update the countdown every second
        var x = setInterval(startCountdown, 1000);

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>

    <!-- Nav Bar -->
    <header>
      <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
          <a href="/" class="navbar-brand text-light fs-4">F1 Tracker</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item"><a class="nav-link text-light" href="#home">Home</a></li>
              <li class="nav-item"><a class="nav-link text-light" href="#data">Data</a></li>
              <li class="nav-item"><a class="nav-link text-light" href="#predictions">Predictions</a></li>
            </ul>
            {% if data.signedin %}
            <div class="dropdown text-end">
              <a href="#" class="d-block link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="{{ url_for('static', filename='assets/team_logos/' + data.profilepicture) }}" alt="mdo" width="32" height="32" class="rounded-circle" style="max-width: 100%; max-height: 100%; object-fit: cover;">
              </a>
              <ul class="dropdown-menu text-small">
                {% if data.isadmin %}
                  <li><a class="dropdown-item" href="{{ url_for('admin_terminal') }}">Admin Terminal</a></li>
                  <li><hr class="dropdown-divider"></li>
                {% endif %}
                <li><a class="dropdown-item" href="{{ url_for('settings') }}">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('logout') }}">Sign out</a></li>
              </ul>
            </div>
            {% else %}
            <div class="dropdown text-end">
              <a href="#" class="d-block link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="https://t3.ftcdn.net/jpg/05/70/71/06/360_F_570710660_Jana1ujcJyQTiT2rIzvfmyXzXamVcby8.jpg" alt="mdo" width="32" height="32" class="rounded-circle">
              </a>
              <ul class="dropdown-menu text-small">
                <li><a class="dropdown-item" href="{{ url_for('login') }}">Sign in</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('register') }}">Register</a></li>
              </ul>
            </div>
            {% endif %}
          </div>
        </div>
      </nav>
    </header>

    <main class="container my-5">

      <!-- Toasts (Notification System)-->
      <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
        {% with messages = get_flashed_messages(with_categories=True) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="toast align-items-center text-white bg-{{ category }} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
                <div class="d-flex">
                  <div class="toast-body">
                    {{ message }}
                  </div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <!-- Recommendations -->
      <div id="home" style="height: 10vh;">
      </div>
      <section class="mb-5">
        <h2 class="mb-4">Recommendations</h2>
        <div class="row">
          {% for recommendation in data.graph_recommendations %}
            <div class="col-md-4">
              <div class="card">
                <div class="card-body text-center">
                  <h5 class="card-title">{{ recommendation.graph_type }}</h5>
                  <p class="card-text">{{ recommendation.grand_prix }}</p>
                  <a href="{{ url_for('generate_graph', graphType=recommendation.graph_type, grandPrix=recommendation.grand_prix) }}" class="btn btn-primary">Generate Graph</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    </div>

      <!-- Upcoming Grand Prix -->
      <section class="mb-5">
        <div class="container text-center mt-5">
          <h1>Countdown to the F1 {{ data.upcominggrandprix }}</h1>
          <div id="countdown" class="display-3 mt-4"></div>
      </div>
        <h2>Upcoming Grand Prix</h2>
        <ul class="list-group">
          {% for item in data.upcominggrandprixlist %}
            <li class="list-group-item">{{ item }}</li>
          {% endfor %}
        </ul>
      </section>

      <!-- Graph Generation/F1 Data -->
    <div id ="data" style="height: 10vh;"></div>
      <section class="mb-5">
        <h2>Graph Generation</h2>
        <div class="row">
          <div class="col-md-8">
            <div class="graph-container text-center">
              <img id="graphImage" src="{{ url_for('static', filename='assets/images/graph_placeholder.png') }}" alt="Graph will appear here" class="img-fluid">
            </div>
          </div>
          <div class="col-md-4">
            <div class="dropdown mb-3">
              <button id="graphTypeButton" class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                Select Graph Type
              </button>
              <ul class="dropdown-menu">
                {% for graphtype in data.graphtypes %}
                  <li><button class="dropdown-item" onclick="updateDropdownText('graphTypeButton', '{{ graphtype }}')">{{ graphtype }}</button></li>
                {% endfor %}
              </ul>
            </div>
            <div class="dropdown mb-3">
              <button id="grandPrixButton" class="btn btn-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                Select Grand Prix
              </button>
              <ul class="dropdown-menu">
                {% for gp in data.grandprixlist %}
                  <li><button class="dropdown-item" onclick="updateDropdownText('grandPrixButton', '{{ gp }}')">{{ gp }}</button></li>
                {% endfor %}
              </ul>
            </div>
            <button id="generateGraphButton" class="btn btn-primary w-100" onclick="generateGraph()">Generate Graph</button>
          </div>
        </div>
      </section>

      <!-- Predictions -->
      <div id ="predictions" style="height: 10vh;"></div>
      <section>
        <h2>Grand Prix </h2>
        <div class="row">
          <!-- Race Predictions -->
          <div class="col-md-4">
            <h4>Race Predictions</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Driver</th>
                </tr>
              </thead>
              <tbody>
                {% for row in data.driverrankingsrace %}
                  <tr>
                    <th>{{ row.rank }}</th>
                    <td>{{ row.driver }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="text-center mt-3">
              <button class="btn btn-primary">
                Prediction Certainty <span class="badge bg-secondary">{{ data.predictionaccuracyrace }}</span>
              </button>
            </div>
          </div>

          <!-- Quali Results -->
          <div class="col-md-4">
            <h4>Quali Predictions</h4>
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Driver</th>
                </tr>
              </thead>
              <tbody>
                {% for row in data.driverrankingsquali %}
                  <tr>
                    <th>{{ row.qualifying_rank }}</th>
                    <td>{{ row.driver }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            <div class="text-center mt-3">
              <button class="btn btn-primary">
                Prediction Certainty <span class="badge bg-secondary">{{ data.predictionaccuracyquali }}</span>
              </button>
            </div>
          </div>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </body>
</html>
